(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[191],{2390:function(e,t,s){Promise.resolve().then(s.bind(s,7739))},7739:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return T}});var n=s(7437),a=s(2265),l=s(6463),r=s(2023),o=s(4697),i=s(2513),c=s(1100),d=s(4258),h=s(2873),u=s(2940),x=s(6706),m=s(6780),g=s(4817),p=s(9896),f=s(4635),y=s(1279);class w extends f.ZP{constructor(){super("MemoVaultDB"),this.version(1).stores({notes:"id, title, createdAt, updatedAt, isDeleted, wikiLinks",files:"id, name, type, createdAt",keyMaterials:"id, createdAt"}),this.on("blocked",()=>{console.error("[MemoVaultDB] Database blocked by another tab")}),this.on("versionchange",()=>{console.warn("[MemoVaultDB] Database version changed in another tab"),this.close()})}}let b=null;function j(){return b||(b=new w),b}let v=j();async function N(){try{return await j().notes.filter(e=>!e.isDeleted).reverse().sortBy("updatedAt")}catch(e){throw console.error("[DB] Error fetching notes:",e),Error("Failed to fetch notes")}}async function S(e){try{let t=new Date,s={...e,id:crypto.randomUUID(),createdAt:t,updatedAt:t,isDeleted:!1,wikiLinks:C(e.content)};return await v.notes.add(s),console.log("[DB] Created note: ".concat(s.id)),s}catch(e){throw console.error("[DB] Error creating note:",e),Error("Failed to create note")}}async function k(e,t){try{let s=await v.notes.get(e);if(!s)throw Error("Note ".concat(e," not found"));let n={...s,...t,updatedAt:new Date,wikiLinks:t.content?C(t.content):s.wikiLinks};return await v.notes.put(n),console.log("[DB] Updated note: ".concat(e)),n}catch(t){throw console.error("[DB] Error updating note ".concat(e,":"),t),Error("Failed to update note ".concat(e))}}async function D(e){try{await v.notes.update(e,{isDeleted:!0,updatedAt:new Date}),console.log("[DB] Soft deleted note: ".concat(e))}catch(t){throw console.error("[DB] Error deleting note ".concat(e,":"),t),Error("Failed to delete note ".concat(e))}}function C(e){let t;let s=/\[\[([^\]]+)\]\]/g,n=[];for(;null!==(t=s.exec(e));)n.push(t[1]);return n}var E=s(4062),P=s(4944),I=s(8747);let A={wsUrl:"ws://localhost:3001",reconnectInterval:5e3,maxReconnectAttempts:10};class z{async initialize(e,t,s){try{if(this.ydoc){console.warn("[Sync] Already initialized");return}console.log("[Sync] Initializing for user:",e,"with token:",t),this.userId=e,this.token=t;let n=s||"user-".concat(e);this.ydoc=new E.QW,this.idbProvider=new P.H7("memovault-".concat(n),this.ydoc),await new Promise(e=>{this.idbProvider.on("synced",()=>{console.log("[Sync] IndexedDB synced"),e()}),this.idbProvider.on("sync",()=>{console.log("[Sync] IndexedDB syncing...")}),setTimeout(()=>{var t;(null===(t=this.idbProvider)||void 0===t?void 0:t.synced)||(console.warn("[Sync] IndexedDB sync timeout, continuing..."),e())},5e3)});let a=A.wsUrl;this.wsProvider=new I.VU(a,n,this.ydoc,{connect:!0,params:{token,userId}}),this.wsProvider.on("status",e=>{switch(console.log("[Sync] WebSocket status:",e.status),e.status){case"connected":this.updateState({status:"synced",lastSyncAt:new Date,pendingChanges:0}),this.reconnectAttempts=0,this.clearReconnectTimer();break;case"connecting":this.updateState({status:"syncing"});break;case"disconnected":this.updateState({status:"idle"}),this.scheduleReconnect()}}),this.wsProvider.on("connection-error",e=>{console.error("[Sync] WebSocket connection error:",e),this.updateState({status:"error",errorMessage:e.message})}),this.ydoc.on("update",(e,t)=>{var s;(!t||t===(null===(s=this.wsProvider)||void 0===s?void 0:s.awareness.clientID))&&this.state.pendingChanges++}),console.log("[Sync] Initialized successfully")}catch(e){throw console.error("[Sync] Initialization error:",e),Error("Failed to initialize sync engine")}}async disconnect(){try{this.clearReconnectTimer(),this.wsProvider&&(this.wsProvider.disconnect(),this.wsProvider.destroy(),this.wsProvider=null),this.idbProvider&&(await this.idbProvider.destroy(),this.idbProvider=null),this.ydoc&&(this.ydoc.destroy(),this.ydoc=null),this.userId=null,this.token=null,this.updateState({status:"idle",pendingChanges:0}),console.log("[Sync] Disconnected")}catch(e){throw console.error("[Sync] Disconnect error:",e),Error("Failed to disconnect sync engine")}}getDoc(){return this.ydoc}getState(){return{...this.state}}onStateChange(e){return this.stateChangeListeners.add(e),()=>{this.stateChangeListeners.delete(e)}}async forceSync(){try{if(!this.wsProvider||!this.wsProvider.wsconnected)throw Error("WebSocket not connected");this.updateState({status:"syncing"}),await new Promise(e=>{let t=setTimeout(()=>e(),2e3);this.wsProvider.on("sync",()=>{clearTimeout(t),e()})}),this.updateState({status:"synced",lastSyncAt:new Date,pendingChanges:0}),console.log("[Sync] Force sync completed")}catch(e){throw console.error("[Sync] Force sync error:",e),this.updateState({status:"error",errorMessage:e instanceof Error?e.message:"Unknown error"}),e}}getNotesData(){return this.ydoc?this.ydoc.getMap("notes"):null}getFilesData(){return this.ydoc?this.ydoc.getMap("files"):null}saveNote(e,t){if(!this.ydoc)throw Error("Sync engine not initialized");this.ydoc.getMap("notes").set(e,t),console.log("[Sync] Saved note: ".concat(e))}deleteNote(e){if(!this.ydoc)throw Error("Sync engine not initialized");this.ydoc.getMap("notes").delete(e),console.log("[Sync] Deleted note: ".concat(e))}saveFile(e,t){if(!this.ydoc)throw Error("Sync engine not initialized");this.ydoc.getMap("files").set(e,t),console.log("[Sync] Saved file: ".concat(e))}deleteFile(e){if(!this.ydoc)throw Error("Sync engine not initialized");this.ydoc.getMap("files").delete(e),console.log("[Sync] Deleted file: ".concat(e))}getOnlineUsers(){return this.wsProvider?Array.from(this.wsProvider.awareness.getStates().values()):[]}setUserState(e){this.wsProvider&&this.wsProvider.awareness.setLocalStateField("user",e)}updateState(e){this.state={...this.state,...e},this.stateChangeListeners.forEach(e=>{e(this.state)})}scheduleReconnect(){if(this.reconnectAttempts>=A.maxReconnectAttempts){console.error("[Sync] Max reconnect attempts reached"),this.updateState({status:"error",errorMessage:"Max reconnect attempts reached"});return}this.clearReconnectTimer(),this.reconnectTimer=setTimeout(()=>{this.reconnectAttempts++,console.log("[Sync] Reconnecting... (attempt ".concat(this.reconnectAttempts,")")),this.wsProvider&&this.wsProvider.connect()},A.reconnectInterval)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}constructor(){this.ydoc=null,this.wsProvider=null,this.idbProvider=null,this.userId=null,this.token=null,this.state={status:"idle",pendingChanges:0},this.reconnectAttempts=0,this.reconnectTimer=null,this.stateChangeListeners=new Set}}let L=new z;function F(e){let{notes:t,selectedNoteId:s,onNoteSelect:a,onNewNote:l,onNoteDelete:h,isOpen:u,onToggle:x,onNavigateToGraph:m}=e;return(0,n.jsxs)("aside",{className:"\n        fixed left-0 top-0 h-full bg-slate-900 text-white\n        transition-all duration-300 ease-in-out z-40\n        ".concat(u?"w-72":"w-0 overflow-hidden","\n        lg:relative lg:translate-x-0\n      "),children:[(0,n.jsxs)("div",{className:"p-4 border-b border-slate-700",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,n.jsxs)("h1",{className:"text-xl font-bold flex items-center gap-2",children:[(0,n.jsx)(r.Z,{className:"w-6 h-6"}),"MemoVault"]}),(0,n.jsx)("button",{onClick:x,className:"lg:hidden p-2 hover:bg-slate-800 rounded-lg",children:(0,n.jsx)(o.Z,{className:"w-5 h-5"})})]}),(0,n.jsxs)("button",{onClick:()=>l(),className:"w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg transition-colors",children:[(0,n.jsx)(i.Z,{className:"w-4 h-4"}),"新建笔记"]})]}),(0,n.jsxs)("nav",{className:"p-4",children:[(0,n.jsxs)("button",{onClick:m,className:"w-full flex items-center gap-3 p-3 hover:bg-slate-800 rounded-lg transition-colors mb-2",children:[(0,n.jsx)(c.Z,{className:"w-5 h-5"}),"知识图谱"]}),(0,n.jsxs)("button",{className:"w-full flex items-center gap-3 p-3 hover:bg-slate-800 rounded-lg transition-colors mb-2",children:[(0,n.jsx)(d.Z,{className:"w-5 h-5"}),"设置"]})]}),(0,n.jsxs)("div",{className:"p-4 border-t border-slate-700 overflow-y-auto flex-1",children:[(0,n.jsx)("h2",{className:"text-sm font-semibold text-slate-400 mb-3",children:"笔记"}),(0,n.jsx)("ul",{className:"space-y-1",children:0===t.length?(0,n.jsx)("li",{className:"text-slate-500 text-sm text-center py-4",children:"暂无笔记"}):t.map(e=>(0,n.jsx)("li",{children:(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsxs)("button",{onClick:()=>a(e.id),className:"\n                      flex-1 text-left p-3 rounded-lg transition-colors\n                      ".concat(s===e.id?"bg-blue-600 text-white":"hover:bg-slate-800","\n                    "),children:[(0,n.jsx)("div",{className:"font-medium truncate",children:e.title}),(0,n.jsx)("div",{className:"text-xs text-slate-400 mt-1",children:new Date(e.updatedAt).toLocaleDateString("zh-CN")})]}),(0,n.jsx)("button",{onClick:()=>h(e.id),className:"p-2 hover:bg-red-600 rounded-lg transition-colors text-slate-400 hover:text-white",title:"删除笔记",children:(0,n.jsx)(o.Z,{className:"w-4 h-4"})})]})},e.id))})]})]})}function M(e){let{onToggleSidebar:t,onOpenSearch:s,onOpenSettings:a,syncState:l,onLogout:r}=e;return(0,n.jsxs)("header",{className:"bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between sticky top-0 z-30",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4",children:[(0,n.jsx)("button",{onClick:t,className:"lg:hidden p-2 hover:bg-slate-100 rounded-lg",children:(0,n.jsx)(h.Z,{className:"w-6 h-6"})}),(0,n.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:["synced"===l.status&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(u.Z,{className:"w-4 h-4 text-green-500"}),(0,n.jsx)("span",{className:"text-slate-600",children:"已同步"})]}),"syncing"===l.status&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(x.Z,{className:"w-4 h-4 text-blue-500 animate-spin"}),(0,n.jsx)("span",{className:"text-slate-600",children:"同步中..."})]}),"error"===l.status&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(m.Z,{className:"w-4 h-4 text-red-500"}),(0,n.jsx)("span",{className:"text-slate-600",children:"同步失败"})]}),"idle"===l.status&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("span",{className:"text-slate-400",children:"离线（WebSocket 未启动）"})})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)("button",{onClick:s,className:"flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors",children:[(0,n.jsx)(g.Z,{className:"w-4 h-4"}),(0,n.jsx)("span",{className:"text-sm text-slate-600 hidden sm:inline",children:"搜索 (Ctrl+K)"})]}),(0,n.jsxs)("button",{onClick:a,className:"flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors",children:[(0,n.jsx)(d.Z,{className:"w-4 h-4"}),(0,n.jsx)("span",{className:"text-sm text-slate-600 hidden sm:inline",children:"设置"})]}),(0,n.jsx)("button",{onClick:r,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",title:"登出",children:(0,n.jsx)(p.Z,{className:"w-5 h-5 text-slate-600"})})]})]})}function Z(e){let{selectedNote:t,onNoteChange:s,onSave:l}=e,[o,i]=(0,a.useState)("");return((0,a.useEffect)(()=>{t&&i(t.content)},[t]),t)?(0,n.jsxs)("main",{className:"flex-1 flex flex-col bg-white",children:[(0,n.jsx)("div",{className:"border-b border-slate-200 px-6 py-4",children:(0,n.jsx)("input",{type:"text",value:t.title,onChange:e=>s({title:e.target.value}),className:"w-full text-2xl font-bold bg-transparent border-none outline-none placeholder-slate-400",placeholder:"笔记标题..."})}),(0,n.jsx)("div",{className:"flex-1 p-6 overflow-y-auto",children:(0,n.jsx)("textarea",{value:o,onChange:e=>{i(e.target.value),s({content:e.target.value})},onBlur:l,className:"w-full h-full resize-none bg-transparent border-none outline-none text-slate-700 leading-relaxed placeholder-slate-400",placeholder:"开始写作...",style:{minHeight:"calc(100vh - 300px)"}})}),(0,n.jsxs)("div",{className:"border-t border-slate-200 px-6 py-3 flex items-center justify-between text-sm text-slate-500",children:[(0,n.jsxs)("div",{children:["最后更新: ",new Date(t.updatedAt).toLocaleString("zh-CN")]}),(0,n.jsx)("div",{children:"支持 [[WikiLink]] 语法"})]})]}):(0,n.jsx)("div",{className:"flex-1 flex items-center justify-center bg-slate-50",children:(0,n.jsxs)("div",{className:"text-center text-slate-500",children:[(0,n.jsx)(r.Z,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),(0,n.jsx)("p",{className:"text-lg",children:"选择或创建一个笔记开始"})]})})}function B(e){let{selectedNoteId:t,onNoteSelect:s,onNewNote:l,onLogout:r}=e,[i,c]=(0,a.useState)(!0),[d,h]=(0,a.useState)(!1),[u,x]=(0,a.useState)(!1),[m,p]=(0,a.useState)(""),f=(0,y.yR)(()=>N(),[],[]),w=function(){let[e,t]=(0,a.useState)(L.getState());return(0,a.useEffect)(()=>{let e=L.onStateChange(e=>{t(e)});return()=>{e()}},[]),e}(),b=(0,a.useMemo)(()=>{if(!m)return[];let e=m.toLowerCase();return f.filter(t=>t.title.toLowerCase().includes(e)||t.content.toLowerCase().includes(e))},[f,m]),j=f.find(e=>e.id===t),v=async()=>{await l(),window.innerWidth<1024&&c(!1)},S=()=>{h(!0),p("")},C=()=>{h(!1),p("")},E=e=>{s(e),C()},P=()=>{x(!1)},I=async e=>{if(j)try{await k(j.id,e),console.log("Note updated:",e)}catch(e){console.error("Error updating note:",e),alert("保存笔记失败")}},A=async e=>{if(confirm("确定要删除这个笔记吗？"))try{await D(e),t===e&&s("")}catch(e){console.error("Error deleting note:",e),alert("删除笔记失败")}};return(0,a.useEffect)(()=>{let e=e=>{(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),S()),"Escape"===e.key&&(d&&C(),u&&P())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,n.jsxs)("div",{className:"flex h-screen bg-slate-100 overflow-hidden",children:[(0,n.jsx)(F,{notes:f,selectedNoteId:t,onNoteSelect:e=>{s(e),window.innerWidth<1024&&c(!1)},onNewNote:v,onNoteDelete:A,isOpen:i,onToggle:()=>c(!i),onNavigateToGraph:()=>{console.log("Navigating to graph...")}}),i&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden",onClick:()=>c(!1)}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col overflow-hidden",children:[(0,n.jsx)(M,{onToggleSidebar:()=>c(!i),onOpenSearch:S,onOpenSettings:()=>{x(!0)},syncState:w,onLogout:r}),(0,n.jsx)(Z,{selectedNote:j,onNoteChange:I,onSave:()=>{console.log("Note saved")}})]}),d&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold",children:"搜索笔记"}),(0,n.jsx)("button",{onClick:C,className:"p-2 hover:bg-slate-100 rounded-lg",children:(0,n.jsx)(o.Z,{className:"w-6 h-6"})})]}),(0,n.jsx)("div",{className:"p-6",children:(0,n.jsx)("input",{type:"text",value:m,onChange:e=>{p(e.target.value)},placeholder:"输入关键词搜索...",className:"w-full px-4 py-3 border border-slate-300 rounded-lg text-lg outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",autoFocus:!0})}),(0,n.jsx)("div",{className:"flex-1 overflow-y-auto p-6",children:b&&0===b.length?(0,n.jsxs)("div",{className:"text-center text-slate-500 py-8",children:[(0,n.jsx)(g.Z,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),(0,n.jsx)("p",{children:"没有找到匹配的笔记"})]}):b&&b.length>0?(0,n.jsx)("ul",{className:"space-y-2",children:b.map(e=>(0,n.jsx)("li",{children:(0,n.jsxs)("button",{onClick:()=>E(e.id),className:"w-full text-left p-4 rounded-lg hover:bg-slate-100 transition-colors",children:[(0,n.jsx)("div",{className:"font-semibold text-lg",children:e.title}),(0,n.jsx)("div",{className:"text-sm text-slate-500 mt-1 line-clamp-2",children:e.content||"无内容"})]})},e.id))}):null})]})}),u&&(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:(0,n.jsxs)("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-slate-200",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold",children:"设置"}),(0,n.jsx)("button",{onClick:P,className:"p-2 hover:bg-slate-100 rounded-lg",children:(0,n.jsx)(o.Z,{className:"w-6 h-6"})})]}),(0,n.jsxs)("div",{className:"p-6 space-y-6",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"font-semibold text-lg",children:"用户信息"}),(0,n.jsx)("p",{className:"text-sm text-slate-500",children:localStorage.getItem("email")})]}),(0,n.jsx)("button",{onClick:r,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"登出"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"font-semibold text-lg mb-2",children:"应用信息"}),(0,n.jsxs)("div",{className:"space-y-2 text-sm text-slate-600",children:[(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:"版本"}),(0,n.jsx)("span",{className:"font-medium",children:"0.1.0"})]}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:"数据存储"}),(0,n.jsx)("span",{className:"font-medium",children:"本地 IndexedDB"})]}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:"加密方式"}),(0,n.jsx)("span",{className:"font-medium",children:"PBKDF2 + AES-GCM-256"})]}),(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsx)("span",{children:"同步状态"}),(0,n.jsx)("span",{className:"font-medium ".concat("synced"===w.status?"text-green-600":"syncing"===w.status?"text-blue-600":"error"===w.status?"text-red-600":"text-slate-400"),children:"synced"===w.status?"已同步":"syncing"===w.status?"同步中...":"error"===w.status?"同步失败":"离线"})]})]})]}),(0,n.jsx)("div",{className:"border-t border-slate-200 pt-6",children:(0,n.jsx)("p",{className:"text-xs text-slate-400 text-center",children:"MemoVault - 隐私优先的个人知识库"})})]})]})})]})}function T(){let e=(0,l.useRouter)(),[t,s]=(0,a.useState)(null),[r,o]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let t=localStorage.getItem("token");if(t){o(!0);let e=localStorage.getItem("userId");e&&t&&L.initialize(e,t,"user-".concat(e)).then(()=>{console.log("[App] Sync engine initialized")}).catch(e=>{console.error("[App] Failed to initialize sync engine:",e)})}else e.push("/")},[e]);let i=async()=>{try{let e=await S({title:"新笔记",content:"",tags:[],isDeleted:!1,wikiLinks:[]});s(e.id)}catch(e){console.error("Error creating note:",e),alert("创建笔记失败")}},c=async()=>{await L.disconnect(),localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("email"),localStorage.removeItem("salt"),e.push("/")};return r?(0,n.jsx)(B,{selectedNoteId:t,onNoteSelect:s,onNewNote:i,onLogout:c}):(0,n.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,n.jsx)("p",{className:"text-slate-600",children:"加载中..."})]})})}}},function(e){e.O(0,[900,516,41,971,23,744],function(){return e(e.s=2390)}),_N_E=e.O()}]);